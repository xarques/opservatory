<div class="container">
  <div>
    <h4><%= @exercise.challenge.name %> <span id="clock-status"><%= render 'exercise_status', exercise: @exercise %></span></h4>
    </div>
  <div class="exercise">
    <div class="description">
      <div id="exercise-app" class="exercise-app"> </div>
      <div class="">
        <h5><strong>The Goal</strong></h45>
        <p><%= @exercise.challenge.description %></p>
      </div>
      <div>
        <h5><strong>Rules</strong></h5>
        <%= @exercise.challenge.instructions.html_safe if @exercise.challenge.instructions %>
      </div>
    </div>

    <div class="hints">
      <% if @next_hint.count == 0 %>
        <% disabled_class = "btn btn-primary btn-exercise disabled" %>
      <% else %>
        <% disabled_class = "btn btn-primary btn-exercise" %>
      <% end %>
      <%= link_to "Need a hint" , exercise_exercise_hints_path(@exercise.id), method: "post", :class => disabled_class, :id => "button-hint", remote: true %>
      <div class="hints-details" id="hints">
        <ul id="list_hints" class="list-unstyled">
         <% @given_hints.each do |hint|%>
         <li><%= hint.description %></li>
         <% end %>
        </ul>
      </div>
    </div>

    <div class="editor text-center">
      <div id="javascript-editor"></div>
      <div class="editor-buttons text-center">
        <div class="editor-buttons-flex">
          <%= link_to "Retry", retry_exercise_path(@exercise), method: "patch", :class =>"btn btn-primary btn-exercise", :id =>"retry", :type =>"button", remote: true, :onclick => 'retry()' %>
          <%= simple_form_for(@exercise, remote: true, :html => { :onsubmit => 'validate()' }, :method => 'patch' ) do |form| %>
            <%= form.hidden_field :code %>
            <%= form.hidden_field :status %>
            <%= form.button :submit, "Validate", class: "btn btn-primary btn-exercise" %>
          <% end %>
          <% if @exercise.challenge.deployable %>
            <% if @exercise.status == 1 || @exercise.status == 3 %>
              <% disabled = "btn btn-primary btn-exercise" %>
            <% else %>
              <% disabled = "btn btn-primary btn-exercise disabled" %>
            <% end %>
            <button type="button" id="deploy" class="<%= disabled %>" onclick="deploy()">
              Deploy
            </button>
          <% end %>
          <button type="button" id="skip" class="btn btn-primary btn-exercise">
            Skip >>
          </button>
        </div>
      <%#= link_to 'Back', exercises_path %>
      </div>
    </div>

    <div class="result" >
      <h5>Results:</h5>
      <div class="result-details" id="result">

      </div>
    </div>
    <%# content_for :after_js do %>
      <!-- method aceEditor is defined in app/javascript/packs/editor.js -->
      <%= javascript_pack_tag 'editor' %>
    <%# end %>

    <script>
      const retry = (() => {
        swal({
          title: 'Do you want to retry this exercise ?',
          text: "The code and the tips will be reinitialized",
          type: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#3085d6',
          cancelButtonColor: '#d33',
          confirmButtonText: 'Yes, reset it!'
        }).then((result) => {
          return true;
        });
      });
      const validate = (() => {
        validateExercise('<%=j raw(@exercise.challenge.schema) %>', javascriptEditor.getValue(), "result");
      });
      const deploy = (() => {
        deployExercise('<%=j raw(@exercise.challenge.schema) %>', javascriptEditor.getValue(), "result");
      });
      // methods aceEditor and validateExerciseCallback are defined in app/javascript/packs/editor.js
      const javascriptEditor = aceEditor("javascript-editor", "<%=j raw(@exercise.code) %>");
      // validateExerciseCallback('<%#=j raw(@exercise.challenge.schema) %>', javascriptEditor, "validate", "result");
      <% if @exercise.challenge.deployable && (@exercise.status == 3 || @exercise.status == 1 )%>
        setBucketName(getBucketName(javascriptEditor.getValue()));
      <% end %>
    </script>
  </div>
</div>
